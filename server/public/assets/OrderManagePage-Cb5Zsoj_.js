import{d as Dt,b as Ct,n as g,c as x,o as ht,v as V,e as q,f as w,p as D,i as e,j as r,w as y,k as C,q as L,F as T,y as E,z as H,t as p,h as J,T as St,m as i,_ as Vt}from"./index-KTdWOH4t.js";const qt={class:"order-management"},bt={class:"search-area"},kt={key:0,class:"permission-notice"},It={class:"table-section"},Nt={class:"order-table"},Pt={key:0,style:{width:"80px","text-align":"center"}},Ot=["onClick"],$t={key:0,style:{"text-align":"center"}},xt={key:0,class:"product-details-row"},Bt=["colspan"],Mt={class:"product-table"},Ut={key:1,class:"form-section"},zt={class:"form-row"},Ft={class:"form-group",style:{width:"240px"}},Lt={class:"form-group"},Tt={class:"form-group"},Yt={class:"form-group"},At={class:"products-section"},jt={class:"section-header"},Et={class:"product-table"},Qt={style:{"text-align":"center"}},Rt={class:"form-actions"},Gt={key:2,class:"permission-info-section"},Ht={class:"permission-content"},Jt={class:"current-permission"},Kt={class:"status-modal-content"},Wt={class:"current-status"},Xt={class:"form-group"},Zt={class:"modal-footer"},te=Dt({__name:"OrderManagePage",setup(ee){const K=Ct(),{canManageSales:m,userRole:W}=K,B=g([]),I=g([]),b=g([]),M=g(""),N=g(!1),P=g(null),U=g(!1),h=g(null),Y=g(!1),k=g({newStatus:""}),X=g(["대기","진행중","완료","지연","취소"]),Q=o=>{const t=new Date(o),u=t.getFullYear(),l=("0"+(t.getMonth()+1)).slice(-2),c=("0"+t.getDate()).slice(-2);return`${u}-${l}-${c}`},z=g([]),Z=o=>{const t=z.value.indexOf(o);t>-1?z.value.splice(t,1):z.value.push(o)},tt=x(()=>{const o={};return et.value.forEach(t=>{const u=t.order_id;o[u]||(o[u]={orderId:u,customerName:t.account_name,orderDate:t.order_date,deliveryDate:t.delivery_date,status:t.status,items:[]}),o[u].items.push({productName:t.product_name,productStand:t.product_stand,quantity:t.order_qty,productCode:t.product_code})}),Object.values(o)}),n=g({customerId:"",orderDate:new Date,deliveryDate:new Date,createdBy:"",products:[{productCode:"",productName:"",productStand:"",quantity:1,unitPrice:0}]}),et=x(()=>{if(!M.value)return B.value;const o=M.value.toLowerCase();return B.value.filter(t=>String(t.order_id).toLowerCase().includes(o)||t.account_name.toLowerCase().includes(o))}),ot=x(()=>I.value.filter(o=>o.account_type=="customer").map(o=>({value:o.account_id,label:o.account_name}))),at=x(()=>[...new Set(b.value.map(t=>t.product_name))]);function lt(o){return o?b.value.filter(t=>t.product_name===o).map(t=>t.product_stand):[]}function nt(o){const t=n.value.products[o].quantity;(t<1||isNaN(t))&&(n.value.products[o].quantity=1)}const A=x(()=>n.value.products.map(o=>o.unitPrice*o.quantity));function ut(o){if(!m){alert("주문 상태 변경 권한이 없습니다.");return}h.value=o,k.value.newStatus="",U.value=!0}function R(){U.value=!1,h.value=null}async function rt(){var o,t,u;if(!k.value.newStatus){alert("변경할 상태를 선택하세요.");return}if(k.value.newStatus===((o=h.value)==null?void 0:o.status)){alert("현재 상태와 동일한 상태로는 변경할 수 없습니다.");return}try{Y.value=!0;const l={newStatus:k.value.newStatus};await V.put(`/orders/${h.value.orderId}/status`,l),alert("주문 상태가 변경되었습니다."),R(),await O()}catch(l){console.error("상태 변경 실패:",l),alert(`상태 변경에 실패했습니다.
${((u=(t=l.response)==null?void 0:t.data)==null?void 0:u.message)||"알 수 없는 오류"}`)}finally{Y.value=!1}}ht(()=>{console.log("컴포넌트 마운트됨"),O(),st(),dt()});async function O(){try{const o=await V.get("/orders/with-items");console.log("주문 데이터:",o.data),B.value=o.data||[]}catch(o){console.error("주문 조회 실패:",o),B.value=[{order_id:1,account_name:"셀트리온",order_date:"2024-01-15",delivery_date:"2024-01-20",product_name:"타이레놀 500mg",product_stand:"10정",order_qty:100,product_code:"TYL500",status:"진행중"},{order_id:2,account_name:"한미약품",order_date:"2024-01-16",delivery_date:"2024-01-22",product_name:"아스피린 100mg",product_stand:"30정",order_qty:200,product_code:"ASP100",status:"완료"}]}}async function st(){try{const o=await V.get("/account");console.log("거래처 데이터:",o.data),I.value=o.data||[]}catch(o){console.error("거래처 조회 실패:",o),I.value=[{account_id:1,account_name:"셀트리온",account_type:"customer"},{account_id:2,account_name:"한미약품",account_type:"customer"}]}}async function dt(){try{const o=await V.get("/product");console.log("제품 데이터:",o.data),b.value=o.data||[]}catch(o){console.error("제품 조회 실패:",o),b.value=[{product_id:1,product_name:"타이레놀 500mg",product_stand:"10정",product_code:"TYL500",product_pay:5e3},{product_id:2,product_name:"아스피린 100mg",product_stand:"30정",product_code:"ASP100",product_pay:3e3}]}}function ct(){}async function it(o){if(!m){console.log("주문 수정 권한이 없습니다.");return}console.log("주문 수정:",o),N.value=!0,P.value=o.orderId;try{const t=await V.get(`/orders/${o.orderId}/details`);console.log("서버 응답 데이터: ",t.data);const{order:u,items:l}=t.data,c=I.value.find(s=>s.account_name===o.customerName);n.value={customerId:(c==null?void 0:c.account_id)||"",orderDate:new Date(u.order_date),deliveryDate:new Date(u.delivery_date),createdBy:u.created_by||"",products:l.map(s=>({productName:s.product_name,productStand:s.product_stand,productCode:s.product_code,quantity:s.order_qty,unitPrice:s.unit_price||0}))},console.log("폼 데이터 설정 완료: ",n.value)}catch(t){console.error("주문 상세 조회 실패:",t);const u=I.value.find(l=>l.account_name===o.customerName);n.value={customerId:(u==null?void 0:u.account_id)||"",orderDate:new Date(o.orderDate),deliveryDate:new Date(o.deliveryDate),createdBy:"관리자",products:o.items.map(l=>{const c=b.value.find(s=>s.product_name===l.productName&&s.product_stand===l.productStand);return{productName:l.productName,productStand:l.productStand,productCode:l.productCode,quantity:l.quantity,unitPrice:(c==null?void 0:c.product_pay)||0}})}}}function pt(o){console.log("클릭된 order 데이터: ",o),Z(o.orderId),m&&it(o)}async function mt(o){if(!m){alert("주문 관리 권한이 없습니다.");return}if(confirm(`주문번호 ${o.orderId}를 정말 삭제하시겠습니까?`))try{await V.delete(`/orders/${o.orderId}`),alert("삭제되었습니다."),P.value===o.orderId&&$(),O()}catch(t){console.error("삭제 실패:",t),alert("삭제에 실패했습니다.")}}function vt(){n.value.products.push({productName:"",productStand:"",quantity:1,productCode:"",unitPrice:0})}function _t(o){n.value.products.length>1&&n.value.products.splice(o,1)}function yt(o,t){const u=b.value.find(l=>l.product_name==o);u&&(n.value.products[t]={productCode:"",productName:u.product_name,productStand:"",quantity:n.value.products[t].quantity||1,unitPrice:0})}function ft(o,t,u){console.log("규격 업데이트 됨!");const l=b.value.find(c=>c.product_name===o&&c.product_stand===t);if(l){const c=n.value.products[u].quantity,s=l.product_pay;n.value.products[u]={productCode:l.product_code,productName:l.product_name,productStand:l.product_stand,quantity:c,unitPrice:s}}}function $(){n.value={customerId:"",orderDate:new Date,deliveryDate:new Date,createdBy:"",products:[{productName:"",productStand:"",quantity:1,productCode:"",unitPrice:0}]},N.value=!1,P.value=null}async function gt(){var o,t,u,l,c;if(!m){alert("주문 관리 권한이 없습니다.");return}if(!n.value.customerId){alert("거래처를 선택하세요.");return}if(n.value.products.some(s=>!s.productCode)){alert("제품 정보를 모두 입력하세요.");return}if(N.value){const s=f=>{const S=new Date(f),j=S.getFullYear(),a=("0"+(S.getMonth()+1)).slice(-2),d=("0"+S.getDate()).slice(-2);return`${j}-${a}-${d}`},v={account_id:n.value.customerId,order_date:s(n.value.orderDate),delivery_date:s(n.value.deliveryDate),created_by:n.value.createdBy||"관리자",status:"진행중",products:n.value.products.map((f,S)=>({product_code:f.productCode,order_qty:f.quantity,order_price:A.value[S]}))};try{await V.put(`/orders/${P.value}`,v),alert("수정되었습니다."),$(),O()}catch(f){console.error("수정 실패:",f),alert(`수정에 실패했습니다.
${((t=(o=f.response)==null?void 0:o.data)==null?void 0:t.message)||f.message||"알 수 없는 오류"}`)}}else{const s={customerId:{value:n.value.customerId},orderDate:n.value.orderDate,deliveryDate:n.value.deliveryDate,createdBy:n.value.createdBy||"관리자",products:n.value.products.map((v,f)=>({productCode:v.productCode,quantity:v.quantity,orderPrice:A.value[f]}))};console.log("저장할 데이터:",s);try{await V.post("/orders",s),alert("등록되었습니다."),$(),O()}catch(v){console.error("저장 실패:",v),console.error("에러 상세:",(u=v.response)==null?void 0:u.data),alert(`저장에 실패했습니다.
${((c=(l=v.response)==null?void 0:l.data)==null?void 0:c.message)||v.message||"알 수 없는 오류"}`)}}}function wt(){$()}function G(o){return{진행중:"info",완료:"success",지연:"danger",대기:"warning",취소:"secondary"}[o]||"secondary"}return(o,t)=>{const u=q("va-input"),l=q("va-button"),c=q("va-alert"),s=q("va-chip"),v=q("va-select"),f=q("va-date-input"),S=q("va-icon"),j=q("va-modal");return w(),D("div",qt,[t[33]||(t[33]=e("h1",null,"주문 관리",-1)),e("div",bt,[r(u,{modelValue:M.value,"onUpdate:modelValue":t[0]||(t[0]=a=>M.value=a),placeholder:"주문번호, 거래처명 검색",style:{width:"300px"}},null,8,["modelValue"]),r(l,{onClick:ct},{default:y(()=>t[7]||(t[7]=[i("검색")])),_:1,__:[7]})]),C(m)?L("",!0):(w(),D("div",kt,[r(c,{color:"info",icon:"info"},{default:y(()=>t[8]||(t[8]=[i(" 조회 전용 모드입니다. 주문 관리는 영업부서 권한이 필요합니다. ")])),_:1,__:[8]})])),e("div",It,[e("table",Nt,[e("thead",null,[e("tr",null,[t[9]||(t[9]=e("th",null,"주문번호",-1)),t[10]||(t[10]=e("th",null,"거래처명",-1)),t[11]||(t[11]=e("th",null,"주문일",-1)),t[12]||(t[12]=e("th",null,"납기일",-1)),t[13]||(t[13]=e("th",null,"상태",-1)),C(m)?(w(),D("th",Pt,"삭제")):L("",!0)])]),e("tbody",null,[(w(!0),D(T,null,E(tt.value,a=>(w(),D(T,{key:a.orderId},[e("tr",{onClick:d=>pt(a),class:H(["order-header-row",{selected:P.value===a.orderId&&C(m),"read-only":!C(m)}])},[e("td",null,p(a.orderId),1),e("td",null,p(a.customerName),1),e("td",null,p(Q(a.orderDate)),1),e("td",null,p(Q(a.deliveryDate)),1),e("td",null,[r(s,{color:G(a.status),size:"small",class:H({"clickable-status":C(m)}),onClick:J(d=>C(m)?ut(a):null,["stop"]),title:C(m)?"클릭하여 상태 변경":""},{default:y(()=>[i(p(a.status),1)]),_:2},1032,["color","class","onClick","title"])]),C(m)?(w(),D("td",$t,[r(l,{icon:"delete",preset:"plain",size:"medium",color:"danger",onClick:J(d=>mt(a),["stop"]),title:"주문 삭제"},null,8,["onClick"])])):L("",!0)],10,Ot),r(St,{name:"accordion"},{default:y(()=>[z.value.includes(a.orderId)?(w(),D("tr",xt,[e("td",{colspan:C(m)?6:5},[e("table",Mt,[t[14]||(t[14]=e("thead",null,[e("tr",null,[e("th",null,"제품명"),e("th",null,"규격"),e("th",null,"수량"),e("th",null,"제품코드")])],-1)),e("tbody",null,[(w(!0),D(T,null,E(a.items,d=>(w(),D("tr",{key:d.productCode},[e("td",null,p(d.productName),1),e("td",null,p(d.productStand),1),e("td",null,p(d.quantity),1),e("td",null,p(d.productCode),1)]))),128))])])],8,Bt)])):L("",!0)]),_:2},1024)],64))),128))])])]),C(m)?(w(),D("div",Ut,[e("h2",null,p(N.value?"주문 수정":"주문 등록"),1),e("div",zt,[e("div",Ft,[t[15]||(t[15]=e("label",null,[i("거래처 "),e("span",{class:"required"},"*")],-1)),r(v,{modelValue:n.value.customerId,"onUpdate:modelValue":t[1]||(t[1]=a=>n.value.customerId=a),options:ot.value,placeholder:"거래처를 선택하세요",style:{width:"240px"},"text-by":"label","value-by":"value"},null,8,["modelValue","options"])]),e("div",Lt,[t[16]||(t[16]=e("label",null,[i("주문일 "),e("span",{class:"required"},"*")],-1)),r(f,{modelValue:n.value.orderDate,"onUpdate:modelValue":t[2]||(t[2]=a=>n.value.orderDate=a)},null,8,["modelValue"])]),e("div",Tt,[t[17]||(t[17]=e("label",null,[i("납기일 "),e("span",{class:"required"},"*")],-1)),r(f,{modelValue:n.value.deliveryDate,"onUpdate:modelValue":t[3]||(t[3]=a=>n.value.deliveryDate=a)},null,8,["modelValue"])]),e("div",Yt,[t[18]||(t[18]=e("label",null,"작성자",-1)),r(u,{modelValue:n.value.createdBy,"onUpdate:modelValue":t[4]||(t[4]=a=>n.value.createdBy=a),placeholder:"작성자명",style:{width:"250px"}},null,8,["modelValue"])])]),e("div",At,[e("div",jt,[t[20]||(t[20]=e("h3",null,"제품 정보",-1)),r(l,{size:"small",onClick:vt},{default:y(()=>t[19]||(t[19]=[i("제품 추가")])),_:1,__:[19]})]),e("table",Et,[t[21]||(t[21]=e("thead",null,[e("tr",null,[e("th",{style:{width:"186px"}},"제품명"),e("th",{style:{width:"120px"}},"규격 (정)"),e("th",null,"제품코드"),e("th",null,"수량 (box)"),e("th",null,"단가 (원)"),e("th",null,"주문가격 (원)"),e("th",{style:{width:"50px","text-align":"center"}},"삭제")])],-1)),e("tbody",null,[(w(!0),D(T,null,E(n.value.products,(a,d)=>(w(),D("tr",{key:d},[e("td",null,[r(v,{modelValue:a.productName,"onUpdate:modelValue":[_=>a.productName=_,_=>yt(_,d)],options:at.value,placeholder:"제품 선택"},null,8,["modelValue","onUpdate:modelValue","options"])]),e("td",null,[r(v,{modelValue:a.productStand,"onUpdate:modelValue":[_=>a.productStand=_,_=>ft(a.productName,_,d)],options:lt(a.productName),placeholder:"규격 선택",disabled:!a.productName},null,8,["modelValue","onUpdate:modelValue","options","disabled"])]),e("td",null,p(a.productCode),1),e("td",null,[r(u,{modelValue:a.quantity,"onUpdate:modelValue":_=>a.quantity=_,modelModifiers:{number:!0},type:"number",min:"1",onInput:_=>nt(d)},null,8,["modelValue","onUpdate:modelValue","onInput"])]),e("td",null,p(a.unitPrice.toLocaleString()),1),e("td",null,p(A.value[d].toLocaleString()),1),e("td",Qt,[r(l,{icon:"delete",preset:"plain",size:"medium",color:"danger",onClick:_=>_t(d)},null,8,["onClick"])])]))),128))])])]),e("div",Rt,[r(l,{preset:"secondary",onClick:$},{default:y(()=>[r(S,{name:"refresh",class:"mr-1"}),t[22]||(t[22]=i(" 초기화 "))]),_:1,__:[22]}),r(l,{preset:"secondary",onClick:wt},{default:y(()=>t[23]||(t[23]=[i("취소")])),_:1,__:[23]}),r(l,{onClick:gt},{default:y(()=>[i(p(N.value?"수정":"저장"),1)]),_:1})])])):(w(),D("div",Gt,[e("div",Ht,[r(S,{name:"shopping_cart",size:"large",color:"primary"}),t[24]||(t[24]=e("h3",null,"주문 관리 권한 필요",-1)),t[25]||(t[25]=e("p",null,"주문 등록 및 수정은 영업부서 권한이 필요합니다.",-1)),e("div",Jt,[r(s,{color:"info",size:"small"},{default:y(()=>[i(" 현재 권한: "+p(C(W)||"조회 전용"),1)]),_:1})]),t[26]||(t[26]=e("p",{class:"permission-desc"},[i(" 주문 목록은 조회할 수 있지만,"),e("br"),i(" 등록, 수정, 삭제는 영업부서만 가능합니다. ")],-1))])])),r(j,{modelValue:U.value,"onUpdate:modelValue":t[6]||(t[6]=a=>U.value=a),title:"주문 상태 변경",size:"small","hide-default-actions":""},{footer:y(()=>[e("div",Zt,[r(l,{preset:"secondary",onClick:R},{default:y(()=>t[31]||(t[31]=[i(" 취소 ")])),_:1,__:[31]}),r(l,{onClick:rt,loading:Y.value},{default:y(()=>t[32]||(t[32]=[i(" 변경 ")])),_:1,__:[32]},8,["loading"])])]),default:y(()=>{var a,d,_;return[e("div",Kt,[e("div",Wt,[e("p",null,[t[27]||(t[27]=e("strong",null,"주문번호:",-1)),i(" "+p((a=h.value)==null?void 0:a.orderId),1)]),e("p",null,[t[28]||(t[28]=e("strong",null,"거래처:",-1)),i(" "+p((d=h.value)==null?void 0:d.customerName),1)]),e("p",null,[t[29]||(t[29]=e("strong",null,"현재 상태:",-1)),r(s,{color:G((_=h.value)==null?void 0:_.status),size:"small"},{default:y(()=>{var F;return[i(p((F=h.value)==null?void 0:F.status),1)]}),_:1},8,["color"])])]),e("div",Xt,[t[30]||(t[30]=e("label",null,[i("변경할 상태 "),e("span",{class:"required"},"*")],-1)),r(v,{modelValue:k.value.newStatus,"onUpdate:modelValue":t[5]||(t[5]=F=>k.value.newStatus=F),options:X.value,placeholder:"상태를 선택하세요"},null,8,["modelValue","options"])])])]}),_:1},8,["modelValue"])])}}}),ae=Vt(te,[["__scopeId","data-v-05a5fe52"]]);export{ae as default};
//# sourceMappingURL=OrderManagePage-Cb5Zsoj_.js.map
